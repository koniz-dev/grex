name: Deploy iOS

# ========================================================================
# Workflow Triggers Configuration
# ========================================================================
# This is a starter template, so triggers are commented out by default.
# Uncomment and configure according to your deployment strategy:
#
# Option 1: Deploy on version tags
#   push:
#     tags:
#       - 'v*.*.*'  # Deploy when version tag is pushed (e.g., v1.0.0)
#
# Option 2: Deploy on branch push
#   push:
#     branches: [ main ]  # Deploy when pushing to main branch
#
# Option 3: Manual trigger only (workflow_dispatch)
#   - Keep push triggers commented
#   - Use GitHub Actions UI to trigger manually
# ========================================================================
on:
  # push:
  #   tags:
  #     - 'v*.*.*'  # Uncomment to deploy on version tags
  #   branches: [ main ]  # Uncomment to deploy on branch push
  workflow_dispatch:  # Allows manual trigger from GitHub Actions UI
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    name: Deploy to App Store
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=production" >> $GITHUB_OUTPUT
          fi

      # - name: Setup App Store Connect API Key
      #   env:
      #     APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
      #     APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      #     APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      #   run: |
      #     mkdir -p ~/private_keys
      #     echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 -d > ~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8
      #     chmod 600 ~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8

      # - name: Setup certificates and profiles
      #   env:
      #     APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
      #     APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      #     APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      #     APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      #   run: |
      #     # Create keychain
      #     security create-keychain -p "" build.keychain
      #     security default-keychain -s build.keychain
      #     security unlock-keychain -p "" build.keychain
      #     security set-keychain-settings -t 3600 -u build.keychain

      #     # Import certificate
      #     echo "$APPLE_CERTIFICATE_BASE64" | base64 -d > certificate.p12
      #     security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
      #     security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain

      #     # Install fastlane
      #     sudo gem install fastlane

      # - name: Build IPA
      #   env:
      #     BASE_URL: ${{ secrets.BASE_URL_PRODUCTION }}
      #     APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      #     APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      #   run: |
      #     ENV="${{ steps.env.outputs.environment }}"
      #     if [ "$ENV" == "staging" ]; then
      #       BASE_URL="${{ secrets.BASE_URL_STAGING }}"
      #     else
      #       BASE_URL="${{ secrets.BASE_URL_PRODUCTION }}"
      #     fi
          
      #     flutter build ipa \
      #       --release \
      #       --dart-define=ENVIRONMENT="$ENV" \
      #       --dart-define=BASE_URL="$BASE_URL"

      # - name: Upload to App Store Connect
      #   env:
      #     APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      #     APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      #   run: |
      #     cd ios
      #     fastlane deliver \
      #       --ipa "../build/ios/ipa/Runner.ipa" \
      #       --skip_screenshots \
      #       --skip_metadata \
      #       --force \
      #       --api_key_path ~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8 \
      #       --api_key_id ${APP_STORE_CONNECT_KEY_ID} \
      #       --api_issuer ${APP_STORE_CONNECT_ISSUER_ID}

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ios-ipa
          path: build/ios/ipa/*.ipa
